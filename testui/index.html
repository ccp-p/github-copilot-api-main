<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI 对话助手 - GitHub Copilot</title>
  <link rel="stylesheet" href="app.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
  <div id="app">
    <!-- 顶部导航栏 -->
    <header class="app-header">
      <div class="header-content">
        <div class="header-left">
          <i class="bi bi-robot"></i>
          <h1>AI 对话助手</h1>
          <span class="status-badge" :class="statusClass">{{ statusText }}</span>
        </div>
        <div class="header-right">
          <button @click="toggleTheme" class="icon-btn" :title="themeTitle">
            <i :class="themeIcon"></i>
          </button>
          <button @click="showSettings = !showSettings" class="icon-btn" title="设置">
            <i class="bi bi-gear"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- 主内容区域 -->
    <div class="app-container">
      <!-- 侧边栏 -->
      <aside class="sidebar" :class="{ 'show': showSidebar }">
        <div class="sidebar-header">
          <h3>对话历史</h3>
          <button @click="clearHistory" class="icon-btn" title="清空历史">
            <i class="bi bi-trash"></i>
          </button>
        </div>
        
        <div class="sidebar-content">
          <div v-if="conversations.length === 0" class="empty-state">
            <i class="bi bi-chat-dots"></i>
            <p>还没有对话记录</p>
          </div>
          <div v-else class="conversation-list">
            <div 
              v-for="conv in conversations" 
              :key="conv.id"
              class="conversation-item"
              :class="{ active: conv.id === currentConversationId }"
            >
              <div class="conversation-info" @click="loadConversation(conv.id)">
                <div class="conversation-title">{{ conv.title }}</div>
                <div class="conversation-time">{{ formatTime(conv.timestamp) }}</div>
              </div>
              <button class="delete-btn" @click.stop="deleteConversation(conv.id)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </aside>

      <!-- 聊天区域 -->
      <main class="chat-main">
        <!-- 认证卡片 -->
        <div v-if="!isAuthenticated" class="auth-card">
          <div class="auth-content">
            <i class="bi bi-shield-lock"></i>
            <h2>需要认证</h2>
            <p>请输入您的 GitHub Token 以开始使用</p>
            <div class="auth-form">
              <input 
                v-model="githubToken" 
                type="password" 
                placeholder="输入 GitHub Token (gho_...)"
                @keyup.enter="authenticate"
                class="auth-input"
              >
              <button @click="authenticate" :disabled="authenticating" class="btn btn-primary">
                <span v-if="authenticating">
                  <i class="bi bi-arrow-repeat spin"></i> 认证中...
                </span>
                <span v-else>认证</span>
              </button>
            </div>
            <p class="auth-help">
              <a href="https://github.com/settings/tokens" target="_blank">
                <i class="bi bi-question-circle"></i> 如何获取 Token?
              </a>
            </p>
          </div>
        </div>

        <!-- 聊天界面 -->
        <div v-else class="chat-container">
          <!-- 聊天头部 -->
          <div class="chat-header">
            <button class="icon-btn" @click="showSidebar = !showSidebar" title="对话历史">
              <i class="bi bi-list"></i>
            </button>
            
            <div class="header-center">
              <!-- 模型选择器 -->
              <div class="model-selector" v-if="selectedModel">
                <button class="model-btn" @click="showModelSelector = !showModelSelector">
                  <i class="bi bi-cpu"></i>
                  <span>{{ selectedModel.name }}</span>
                  <i class="bi bi-chevron-down"></i>
                </button>
              </div>
              
              <!-- Preset 选择器 -->
              <div class="preset-selector">
                <button class="preset-btn" @click="showPresetSelector = !showPresetSelector">
                  <i class="bi bi-person-circle"></i>
                  <span>{{ selectedPresetName || '选择角色' }}</span>
                  <i class="bi bi-chevron-down"></i>
                </button>
                
                <!-- Preset 下拉菜单 -->
                <div class="preset-dropdown" v-show="showPresetSelector" @click.stop>
                  <div class="preset-list">
                    <button 
                      v-for="preset in allPresets" 
                      :key="preset.id"
                      class="preset-item"
                      :class="{ active: preset.id === selectedPresetId }"
                      @click="selectPreset(preset.id)"
                    >
                      <span class="preset-icon">{{ preset.icon }}</span>
                      <span class="preset-name">{{ preset.name }}</span>
                      <i class="bi bi-check2" v-if="preset.id === selectedPresetId"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- 临时对话标识 -->
              <span v-if="isTemporaryConversation" class="temp-badge" title="临时对话，刷新页面后将消失">
                <i class="bi bi-clock-history"></i> 临时
              </span>
            </div>
            
            <div class="header-actions">
              <button class="icon-btn" @click="newTemporaryConversation" title="新建临时对话">
                <i class="bi bi-chat-dots"></i>
              </button>
              <button class="icon-btn" @click="newConversation" title="新建对话">
                <i class="bi bi-plus-circle"></i>
              </button>
            </div>
          </div>

          <!-- 消息列表 -->
          <div class="messages-container" ref="messagesContainer">
            <div v-if="messages.length === 0" class="welcome-screen">
              <div class="welcome-content">
                <i class="bi bi-chat-heart"></i>
                <h2>欢迎使用 AI 对话助手</h2>
                <p>选择一个角色预设或直接开始对话</p>
                
                <!-- 快速角色选择 -->
                <div class="quick-presets">
                  <button 
                    v-for="preset in quickPresets" 
                    :key="preset.id"
                    @click="selectPreset(preset.id)"
                    class="preset-card"
                  >
                    <span class="preset-icon">{{ preset.icon }}</span>
                    <span class="preset-name">{{ preset.name }}</span>
                    <span class="preset-desc">{{ preset.description }}</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- 消息列表 -->
            <div v-else class="messages-list">
              <div 
                v-for="(msg, index) in messages" 
                :key="index"
                class="message"
                :class="msg.role"
              >
                <div class="message-avatar">
                  <i :class="msg.role === 'user' ? 'bi bi-person-circle' : 'bi bi-robot'"></i>
                </div>
                <div class="message-content">
                  <div class="message-header">
                    <span class="message-role">{{ msg.role === 'user' ? '你' : selectedPresetName || 'AI助手' }}</span>
                    <span class="message-time">{{ formatTime(msg.timestamp) }}</span>
                  </div>
                  <div class="message-body" v-html="formatMessage(msg.content)"></div>
                  <!-- 显示图片（如果有） -->
                  <div v-if="msg.images && msg.images.length > 0" class="message-images">
                    <img v-for="(img, idx) in msg.images" :key="idx" :src="img" alt="上传的图片" class="uploaded-image">
                  </div>
                </div>
              </div>

              <!-- 正在生成中 -->
              <div v-if="isGenerating" class="message assistant generating">
                <div class="message-avatar">
                  <i class="bi bi-robot"></i>
                </div>
                <div class="message-content">
                  <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 输入区域 -->
          <div class="input-container">
            <!-- 当前模型信息 -->
            <div v-if="selectedModel" class="model-info-bar">
              <div class="model-info-left">
                <i class="bi bi-cpu"></i>
                <span class="model-name">{{ selectedModel.name }}</span>
                <span v-if="selectedModel.capabilities.supports.vision" class="model-badge" title="支持图片">
                  <i class="bi bi-image"></i>
                </span>
                <span v-if="selectedModel.capabilities.supports.tool_calls" class="model-badge" title="支持工具调用">
                  <i class="bi bi-tools"></i>
                </span>
              </div>
              <div class="model-info-right">
                <button @click="showModelSelector = true" class="btn-text">
                  <i class="bi bi-arrow-left-right"></i> 切换模型
                </button>
              </div>
            </div>

            <!-- 图片预览 -->
            <div v-if="uploadedImages.length > 0" class="image-preview-bar">
              <div 
                v-for="(img, idx) in uploadedImages" 
                :key="idx"
                class="image-preview-item"
              >
                <img :src="img.dataUrl" alt="预览">
                <button @click="removeImage(idx)" class="remove-image-btn">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>

            <!-- 输入框 -->
            <div class="input-box">
              <button 
                v-if="selectedModel && selectedModel.capabilities.supports.vision"
                @click="triggerImageUpload"
                class="icon-btn"
                title="上传图片"
              >
                <i class="bi bi-image"></i>
              </button>
              
              <textarea 
                v-model="userInput"
                @keydown.enter.exact.prevent="sendMessage"
                placeholder="输入消息... (Enter发送，Shift+Enter换行)"
                class="message-input"
                rows="1"
                ref="messageInput"
              ></textarea>
              
              <button 
                @click="sendMessage" 
                :disabled="!canSend"
                class="send-btn"
                :class="{ 'active': canSend }"
              >
                <i class="bi bi-send-fill"></i>
              </button>

              <input 
                type="file" 
                ref="imageInput" 
                @change="handleImageUpload"
                accept="image/jpeg,image/png,image/webp,image/gif"
                style="display: none"
                multiple
              >
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- 设置面板 -->
    <div v-if="showSettings" class="modal-overlay" @click="showSettings = false">
      <div class="modal-content settings-modal" @click.stop>
        <div class="modal-header">
          <h3>设置</h3>
          <button @click="showSettings = false" class="icon-btn">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        
        <div class="modal-body">
          <div class="settings-section">
            <h4>认证信息</h4>
            <div class="setting-item">
              <label>GitHub Token</label>
              <div class="token-display">
                <input type="password" :value="githubToken" readonly>
                <button @click="logout" class="btn btn-danger">退出登录</button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h4>模型选择</h4>
            <div class="setting-item">
              <label>当前模型</label>
              <select v-model="selectedModelId" class="form-select">
                <option value="">请选择模型</option>
                <option v-for="model in models" :key="model.id" :value="model.id">
                  {{ model.name }} - {{ model.vendor }}
                </option>
              </select>
            </div>
            
            <!-- 模型详细信息 -->
            <div v-if="selectedModel" class="model-details">
              <h5>模型能力</h5>
              <div class="capability-grid">
                <div class="capability-item">
                  <i class="bi bi-cpu"></i>
                  <span>模型家族: {{ selectedModel.capabilities.family }}</span>
                </div>
                <div class="capability-item">
                  <i class="bi bi-file-text"></i>
                  <!-- <span>最大上下文: {{ (selectedModel.capabilities.limits.max_context_window_tokens / 1000).toFixed(0) }}K tokens</span> -->
                </div>
                <div class="capability-item">
                  <i class="bi bi-pencil"></i>
                  <span>最大输出: {{ (selectedModel.capabilities.limits.max_output_tokens / 1000).toFixed(0) }}K tokens</span>
                </div>
                <div class="capability-item" v-if="selectedModel.capabilities.supports.vision">
                  <i class="bi bi-image-fill"></i>
                  <span>支持图片上传</span>
                </div>
                <div class="capability-item" v-if="selectedModel.capabilities.supports.tool_calls">
                  <i class="bi bi-tools"></i>
                  <span>支持工具调用</span>
                </div>
                <div class="capability-item" v-if="selectedModel.capabilities.supports.streaming">
                  <i class="bi bi-lightning-fill"></i>
                  <span>支持流式输出</span>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h4>角色预设</h4>
            <div class="setting-item">
              <label>当前角色</label>
              <select v-model="selectedPresetId" class="form-select">
                <option value="">默认助手</option>
                <option v-for="preset in allPresets" :key="preset.id" :value="preset.id">
                  {{ preset.icon }} {{ preset.name }}
                </option>
              </select>
            </div>
            
            <div class="setting-item">
              <label>系统消息</label>
              <textarea v-model="systemMessage" class="form-textarea" rows="4"></textarea>
            </div>
          </div>

          <div class="settings-section">
            <h4>生成参数</h4>
            <div class="setting-item">
              <label>Temperature: {{ temperature }}</label>
              <input type="range" v-model.number="temperature" min="0" max="1" step="0.1" class="form-range">
              <small>控制输出的随机性，值越高越随机</small>
            </div>
            
            <div class="setting-item">
              <label>Top P: {{ topP }}</label>
              <input type="range" v-model.number="topP" min="0" max="1" step="0.1" class="form-range">
              <small>控制输出的多样性</small>
            </div>
            
            <div class="setting-item">
              <label>Max Tokens: {{ maxTokens }}</label>
              <input type="number" v-model.number="maxTokens" min="100" max="16384" step="100" class="form-input">
              <small>最大生成长度</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 模型选择器 -->
    <div v-if="showModelSelector" class="modal-overlay" @click="showModelSelector = false">
      <div class="modal-content model-selector-modal" @click.stop>
        <div class="modal-header">
          <h3>选择模型</h3>
          <button @click="showModelSelector = false" class="icon-btn">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        
        <div class="modal-body">
          <div class="model-grid">
            <div 
              v-for="model in models" 
              :key="model.id"
              @click="selectModel(model.id)"
              class="model-card"
              :class="{ 'active': model.id === selectedModelId }"
            >
              <div class="model-card-header">
                <h4>{{ model.name }}</h4>
                <span class="model-vendor">{{ model.vendor }}</span>
              </div>
              <div class="model-card-body">
                <div class="model-capability-tags">
                  <span v-if="model.capabilities.supports.vision" class="tag">
                    <i class="bi bi-image"></i> Vision
                  </span>
                  <span v-if="model.capabilities.supports.tool_calls" class="tag">
                    <i class="bi bi-tools"></i> Tools
                  </span>
                  <span v-if="model.capabilities.supports.streaming" class="tag">
                    <i class="bi bi-lightning"></i> Stream
                  </span>
                </div>
                <div class="model-stats">
                  <!-- <small>上下文: {{ (model.capabilities.limits.max_context_window_tokens / 1000).toFixed(0) }}K</small> -->
                  <!-- <small>输出: {{ (model.capabilities.limits.max_output_tokens / 1000).toFixed(0) }}K</small> -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 引入依赖 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="presets.js"></script>
  <script src="app.js"></script>
</body>
</html>
